<ui:composition xmlns="http://www.w3.org/1999/xhtml"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui"
>
	<h:form id="lessonForm">
		<p:socket channel="/register">
			<p:ajax event="message" update="lessonInfo lessonTables"
					oncomplete="PF('pStudentsTable').clearFilters(); PF('aStudentsTable').clearFilters();"/>
		</p:socket>

		<p:panelGrid id="lessonInfo" columns="2" styleClass="noBorder lesson-info">
			<p:panel id="lastVisitInfo" styleClass="visit-info">
				<p:panelGrid columns="2">
					<p:panel styleClass="image">
						<p:graphicImage value="#{imageBean.image}">
							<f:param name="cardUid" value="#{lessonBean.processedStudent.cardUid}"/>
						</p:graphicImage>
					</p:panel>
					<p:panel rendered="#{lessonBean.processedStudent eq null}">
						<p:outputLabel value="#{msg['lesson.visit.noData']}"/>
					</p:panel>
					<p:panel rendered="#{lessonBean.processedStudent ne null}" styleClass="visit-label">
						<p:outputLabel id="visitLastName" value="#{lessonBean.processedStudent.lastName}"/>
						<p:outputLabel id="visitFirstName" value="#{lessonBean.processedStudent.firstName}"/>
						<p:outputLabel id="visitGroup" escape="false"
									   styleClass="font-size-20pt margin-top-20px margin-bottom-20px"
									   value="#{lessonBean.processedStudent.groupNames}"/>
						<p:outputLabel styleClass="lowercase"
									   value="#{lessonBean.getStudentSkip(lessonBean.processedStudent)}"/>
					</p:panel>
				</p:panelGrid>
			</p:panel>
			<p:panel styleClass="right">
				<p:panelGrid columns="1" styleClass="inline">
					<p:panel id="lessonButtons" styleClass="lesson-buttons">
						<p:commandButton title="#{msg['btn.startRecord']}" icon="fa fa-fw fa-play"
										 update=":lessonForm:lessonButtons"
										 actionListener="#{lessonBean.startRecord}"
										 rendered="#{not lessonBean.recordStarted}"/>
						<p:commandButton title="#{msg['btn.stopRecord']}" icon="fa fa-fw fa-stop"
										 update=":lessonForm:lessonButtons"
										 actionListener="#{lessonBean.stopRecord}"
										 rendered="#{lessonBean.recordStarted}"/>

						<p:commandButton title="#{msg['btn.enableSound']}" icon="fa fa-fw fa-volume-up"
										 update=":lessonForm:lessonButtons"
										 actionListener="#{lessonBean.enableSound}"
										 rendered="#{lessonBean.recordStarted and not lessonBean.soundEnabled}"/>
						<p:commandButton title="#{msg['btn.disableSound']}" icon="fa fa-fw fa-volume-off"
										 update=":lessonForm:lessonButtons"
										 actionListener="#{lessonBean.disableSound}"
										 rendered="#{lessonBean.recordStarted and lessonBean.soundEnabled}"/>

						<p:commandButton title="#{msg['btn.addVisit']}" icon="fa fa-fw fa-plus"
										 actionListener="#{lessonBean.initAllStudents}"
										 oncomplete="PF('addStudentsDialog').show()"
										 update=":addStudentsForm:studentDetail"/>

						<p:commandButton title="#{msg['btn.openLessonMode']}"
										 icon="fa fa-fw fa-list"
										 update="@([id$=wrapper])"
										 actionListener="#{menuBean.changeView('lessonMode')}">
							<f:setPropertyActionListener value="#{lessonBean.selectedLesson.stream}"
														 target="#{lessonModeBean.stream}"/>
							<f:setPropertyActionListener value="#{lessonBean.selectedLesson}"
														 target="#{lessonModeBean.lesson}"/>
							<f:setPropertyActionListener value="#{false}" target="#{menuBean.showMenu}"/>
						</p:commandButton>

						<p:commandButton title="#{msg['btn.backToLessons']}" icon="fa fa-fw fa-arrow-left"
										 actionListener="#{lessonBean.returnToLessons}" update="@([id$=wrapper])"/>

						<p:commandButton title="#{msg['btn.hide.menu']}" icon="fa fa-fw fa-align-center"
										 update=":menuForm :lessonForm:lessonButtons"
										 actionListener="#{menuBean.hideMenu}"
										 rendered="#{menuBean.showMenu}"/>
						<p:commandButton title="#{msg['btn.show.menu']}" icon="fa fa-fw fa-align-justify"
										 update=":menuForm :lessonForm:lessonButtons"
										 actionListener="#{menuBean.showMenu}"
										 rendered="#{not menuBean.showMenu}"/>
					</p:panel>
					<p:panelGrid columns="2" styleClass="lesson-text left">
						<p:panel id="attendanceInfo">
							<p:outputLabel value="#{msg['lesson.students.all']} - #{lessonBean.lessonStudents.size()}"/>
							<p:outputLabel
									value="#{msg['lesson.students.present']} - #{lessonBean.getPresentStudentsSize()}"/>
							<p:outputLabel
									value="#{msg['lesson.students.absent']} - #{lessonBean.absentStudents.size()}"/>
							<p:outputLabel rendered="#{lessonBean.getAdditionalStudentsSize() ne ''}"
										   value="#{msg['lesson.students.additional']} - #{lessonBean.getAdditionalStudentsSize()}"/>
						</p:panel>
						<p:panel>
							<p:outputLabel value="#{lessonBean.selectedLesson.stream.name}"/>
							<p:outputLabel rendered="#{lessonBean.selectedLesson.group ne null}"
										   value="#{lessonBean.selectedLesson.group.name}"/>
							<p:outputLabel value="#{lessonBean.selectedLesson.type.name}"/>
							<p:outputLabel value="#{lessonBean.selectedLesson.classes[0].date}"
										   converter="localDateConverter"/>
							<p:outputLabel value="#{lessonBean.selectedLesson.classes[0].schedule.caption}"/>
						</p:panel>
					</p:panelGrid>
				</p:panelGrid>
			</p:panel>
		</p:panelGrid>

		<p:panelGrid id="lessonTables" columns="2" styleClass="noBorder v-align-top lesson-tables">
			<p:dataTable id="presentStudents"
						 var="pStudent"
						 widgetVar="pStudentsTable"
						 value="#{lessonBean.presentStudentsLazyModel}"
						 sortBy="#{pStudent.registrationTime}"
						 sortOrder="descending"
						 resizableColumns="true"
						 selection="#{lessonBean.selectedPresentStudents}"
						 rowKey="#{pStudent.id}"
						 paginator="true"
						 rows="10"
						 paginatorTemplate="{RowsPerPageDropdown} {FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
						 rowsPerPageTemplate="5,10,15"
						 paginatorPosition="bottom"
						 lazy="true">

				<p:ajax event="rowSelectCheckbox" update="removePresentStudentsBtn"/>
				<p:ajax event="rowUnselectCheckbox" update="removePresentStudentsBtn"/>
				<p:ajax event="toggleSelect" update="removePresentStudentsBtn"
						listener="#{lessonBean.onPresentStudentsSelect}"/>

				<p:ajax event="rowSelect" listener="#{lessonBean.onStudentRowSelect}"
						update=":lessonForm:lastVisitInfo"/>

				<p:column selectionMode="multiple" styleClass="w16px center"/>

				<p:column styleClass="transparent-button w20px center">
					<f:facet name="header">
						<p:commandButton id="removePresentStudentsBtn"
										 update=":lessonForm:lessonTables :lessonForm:attendanceInfo"
										 styleClass="w25px"
										 icon="fa fa-fw fa-angle-double-right" title="Remove"
										 actionListener="#{lessonBean.removePresentStudents}"
										 disabled="#{lessonBean.selectedPresentStudents eq null or lessonBean.selectedPresentStudents.size() eq 0}"/>
					</f:facet>
					<p:commandButton update=":lessonForm:lessonTables :lessonForm:attendanceInfo"
									 icon="fa fa-fw fa-angle-right" title="Remove"
									 styleClass="w25px"
									 actionListener="#{lessonBean.removeLessonStudent(pStudent)}"/>
				</p:column>

				<p:column sortBy="#{pStudent.name}"
						  filterBy="#{pStudent.name}"
						  filterMatchMode="startsWith"
						  styleClass="bold">
					<h:outputText value="#{pStudent.name}"/>
				</p:column>

				<p:column headerText="#{msg['total.skip']}"
						  styleClass="center w30px bold"
						  sortBy="#{pStudent.totalSkip}">
					<h:outputText value="#{pStudent.totalSkip}"/>
				</p:column>
				<p:column headerText="#{msg['lecture']}/#{msg['practical']}/#{msg['lab']}"
						  styleClass="center w70px">
					<h:outputText value="#{pStudent.skips}"/>
				</p:column>


				<p:column
						sortBy="#{pStudent.registrationTime}"
						styleClass="center w70px">
					<h:outputText
							value="#{pStudent.registrationTime}"
							converter="localTimeConverter"/>
				</p:column>
			</p:dataTable>

			<p:dataTable id="absentStudents"
						 var="aStudent"
						 widgetVar="aStudentsTable"
						 value="#{lessonBean.absentStudentsLazyModel}"
						 sortBy="#{aStudent.name}"
						 resizableColumns="true"
						 selection="#{lessonBean.selectedAbsentStudents}"
						 rowKey="#{aStudent.id}"
						 paginator="true"
						 rows="10"
						 paginatorTemplate="{RowsPerPageDropdown} {FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
						 rowsPerPageTemplate="5,10,15"
						 paginatorPosition="bottom"
						 lazy="true">
				<p:ajax event="rowSelectCheckbox" update="addAbsentStudentsBtn"/>
				<p:ajax event="rowUnselectCheckbox" update="addAbsentStudentsBtn"/>
				<p:ajax event="toggleSelect" update="addAbsentStudentsBtn"
						listener="#{lessonBean.onAbsentStudentsSelect}"/>

				<p:ajax event="rowSelect" listener="#{lessonBean.onStudentRowSelect}"
						update=":lessonForm:lastVisitInfo"/>

				<p:column selectionMode="multiple" styleClass="w16px center"/>

				<p:column styleClass="transparent-button w20px center">
					<f:facet name="header">
						<p:commandButton id="addAbsentStudentsBtn"
										 update=":lessonForm:lessonTables :lessonForm:lastVisitInfo :lessonForm:attendanceInfo"
										 icon="fa fa-angle-double-left" title="Add"
										 styleClass="w25px"
										 actionListener="#{lessonBean.addAbsentStudents}"
										 disabled="#{lessonBean.selectedAbsentStudents eq null or lessonBean.selectedAbsentStudents.size() eq 0}"/>
					</f:facet>
					<p:commandButton
							update=":lessonForm:lessonTables :lessonForm:lastVisitInfo :lessonForm:attendanceInfo"
							icon="fa fa-fw fa-angle-left" title="Add"
							styleClass="w25px"
							actionListener="#{lessonBean.addLessonStudent(aStudent)}"/>
				</p:column>

				<p:column sortBy="#{aStudent.name}"
						  filterBy="#{aStudent.name}"
						  filterMatchMode="startsWith"
						  styleClass="bold">
					<h:outputText value="#{aStudent.name}"/>
				</p:column>

				<p:column headerText="#{msg['total.skip']}"
						  styleClass="center w30px bold"
						  sortBy="#{aStudent.totalSkip}">
					<h:outputText value="#{aStudent.totalSkip}"/>
				</p:column>
				<p:column headerText="#{msg['lecture']}/#{msg['practical']}/#{msg['lab']}"
						  styleClass="center w70px">
					<h:outputText value="#{aStudent.skips}"/>
				</p:column>

			</p:dataTable>
		</p:panelGrid>
	</h:form>
</ui:composition>
